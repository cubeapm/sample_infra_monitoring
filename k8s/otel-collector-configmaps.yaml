---
# ConfigMap for base configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-base-config
  namespace: default
data:
  base.yaml: |
    receivers:
      # aerospike:
      #   endpoint: "aerospike:3000"
      #   collect_cluster_metrics: true
      #   collection_interval: 60s

      # apache:
      #   endpoint: "http://apache:80/server-status?auto"
      #   collection_interval: 60s

      # elasticsearch:
      #   endpoint: http://elasticsearch:9200
      #   username: elastic
      #   password: elastic
      #   collection_interval: 60s

      # haproxy:
      #   endpoint: http://haproxy:8404/stats
      #   collection_interval: 60s
      #   metrics:
      #     haproxy.connections.total:
      #       enabled: true
      #     haproxy.failed_checks:
      #       enabled: true

      # hostmetrics:
      #   collection_interval: 60s
      #   scrapers:
      #     cpu:
      #     disk:
      #       exclude:
      #         devices:
      #           - ^loop.*$
      #         match_type: regexp
      #       metrics:
      #         system.disk.io:
      #           enabled: false
      #         system.disk.merged:
      #           enabled: false
      #         system.disk.operation_time:
      #           enabled: false
      #         system.disk.operations:
      #           enabled: false
      #         system.disk.pending_operations:
      #           enabled: false
      #         system.disk.weighted_io_time:
      #           enabled: false
      #     filesystem:
      #       exclude_devices:
      #         devices:
      #           - ^/dev/loop.*$
      #         match_type: regexp
      #       metrics:
      #         system.filesystem.inodes.usage:
      #           enabled: false
      #     memory:
      #     network:
      #       metrics:
      #         system.network.connections:
      #           enabled: false
      #         system.network.dropped:
      #           enabled: false
      #         system.network.errors:
      #           enabled: false
      #         system.network.packets:
      #           enabled: false
      #     process:
      #       resource_attributes:
      #         process.cgroup:
      #           enabled: true
      #       metrics:
      #         process.disk.io:
      #           enabled: false
      #         process.memory.virtual:
      #           enabled: false
      #         process.uptime:
      #           enabled: true
      #       mute_process_all_errors: true

      # kafkametrics:
      #   protocol_version: "3.0.0"
      #   cluster_alias: my-kafka-cluster
      #   scrapers: [brokers, topics, consumers]
      #   brokers: kafka:9092
      #   collection_interval: 60s
      #   topic_match: ^[^_].*$
      #   resource_attributes:
      #     kafka.cluster.alias:
      #       enabled: true
      #   metadata:
      #     refresh_interval: 2m

      # memcached:
      #   endpoint: memcached:11211
      #   transport: tcp
      #   collection_interval: 60s

      # mysql:
      #   endpoint: mysql:3306
      #   username: root
      #   password: root
      #   collection_interval: 60s

      # nginx:
      #   endpoint: http://nginx:80/status
      #   collection_interval: 60s

      # postgresql:
      #   endpoint: postgres:5432
      #   username: cubeapm
      #   password: mypassword
      #   collection_interval: 60s
      #   tls:
      #     insecure: true

      # rabbitmq:
      #   endpoint: http://rabbitmq:15672
      #   username: YOUR_USERNAME
      #   password: YOUR_PASSWORD
      #   collection_interval: 60s

      # # Kubernetes receivers
      # k8s_cluster:
      #   collection_interval: 60s
      #   allocatable_types_to_report: [cpu, memory]
      #   metrics:
      #     k8s.node.condition:
      #       enabled: true

    processors:
      batch: {}
      
      memory_limiter:
        check_interval: 1s
        limit_percentage: 80
        spike_limit_percentage: 25

      resourcedetection:
        detectors: [system]
        system:
          hostname_sources: ["os"]

      resource/cube.environment:
        attributes:
          - key: cube.environment
            value: UNSET
            action: upsert

      transform/logs_flatten_map:
        error_mode: ignore
        log_statements:
          - context: log
            conditions:
              - body != nil and IsMap(body)
            statements:
              - set(cache, body)
              - flatten(cache, "")
              - merge_maps(attributes, cache, "upsert")

    exporters:
      debug:
        verbosity: detailed
        sampling_initial: 5
        sampling_thereafter: 1

      otlphttp:
        metrics_endpoint: http://host.docker.internal:3130/api/metrics/v1/save/otlp
        retry_on_failure:
          enabled: false

      otlphttp/metrics:
        metrics_endpoint: http://host.docker.internal:3130/api/metrics/v1/save/otlp
        retry_on_failure:
          enabled: false

      otlphttp/k8s-events:
        logs_endpoint: http://host.docker.internal:3130/api/logs/insert/opentelemetry/v1/logs
        headers:
          Cube-Stream-Fields: event.domain

    connectors:
      forward/aggregator:

    service:
      pipelines:
        # Infrastructure metrics pipeline
        metrics:
          receivers:
            # - mysql
            # - nginx
            - forward/aggregator
          processors:
            - batch
            - resourcedetection
          exporters:
            - otlphttp

        # Kubernetes cluster metrics pipeline
        metrics/k8s:
          receivers:
            - k8s_cluster
          processors:
            - memory_limiter
            - batch
            - resource/cube.environment
          exporters:
            - otlphttp/metrics

        # Kubernetes events logs pipeline
        logs:
          receivers:
            - k8sobjects
          processors:
            - memory_limiter
            - transform/logs_flatten_map
            - batch
            - resource/cube.environment
          exporters:
            - otlphttp/k8s-events

---
# ConfigMap for MongoDB configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-mongodb-config
  namespace: default
data:
  mongodb.yaml: |
    receivers:
      mongodb:
        hosts:
          - endpoint: host.docker.internal:27017
        collection_interval: 60s
        tls:
          insecure: true

    processors:
      batch:
      resource/prod.mongo:
        attributes:
          - key: host.name
            value: PROD-MONGO1
            action: upsert

    service:
      pipelines:
        metrics/mongo:
          receivers:
            - mongodb
          processors:
            - batch
            - resource/prod.mongo
          exporters:
            - forward/aggregator

---
# ConfigMap for Redis configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-redis-config
  namespace: default
data:
  redis.yaml: |
    receivers:
      redis:
        endpoint: host.docker.internal:6379
        collection_interval: 60s
        resource_attributes:
          server.address:
            enabled: true
        metrics:
          redis.cmd.calls:
            enabled: true

    processors:
      batch:
      resource/prod.redis:
        attributes:
          - key: server.address
            value: PROD-REDIS1
            action: upsert

    service:
      pipelines:
        metrics/redis:
          receivers:
            - redis
          processors:
            - batch
            - resource/prod.redis
          exporters:
            - forward/aggregator
